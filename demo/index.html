<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SiphonJS Demonstration - USA Temperatures</title>

  <script async defer
       src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFZ17efCedehtFstP6dLziBgeDPnDdyMs&libraries=visualization&callback=initMap">
  </script>
  <script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
   
</head>
<body>

  <span style="margin-bottom: 10px">
    <center>
      <h1>USA Temperatures</h1>
      <button id="showTemps">Show temperatures</button>
    </center>
  </span>

  <div id="map-canvas" class="heatmap" style="postion: relative; height: 500px; width: 1000px">

  </div>
  <script>
    var map;
    function initMap() {
      // Create the map.
      map = new google.maps.Map(document.getElementById('map-canvas'), {
        zoom: 5,
        center: {lat: 40, lng: -100.1},
        mapTypeId: 'terrain'
      });
    }
    var colors = {
      '-10': '#1E28C9',
      '0': '#288DE1',
      '10': '#28BFE1',
      '20': '#28E1B4',
      '30': '#28E163',
      '40': '#A1E227',
      '50': '#D7E227',
      '60': '#E5BD29',
      '70': '#E88024',
      '80': '#E86E24',
      '90': '#E83324'
    }

    $(document).ready( function() {
      var data = [];

      $('#showTemps').click (function () {
        $.get({
          url: '/temperatures',
          success: function() {
            console.log('success');
          },
          error: function() {
            console.log('error');
          }
        })
      })
      var socket = io('http://138.68.62.90:3000');
      socket.on('connect', function(){
        console.log('connected');
      });
      socket.on('temps', function(newData){
	      for(var i = 0; i < newData.length; i++) {
          if(newData[i]) data.push(newData[i]);
        }
        console.log(data.length)
        //build up the points if this is the last piece
        if(newData.length < 187) {
          console.log('last piece')
          // Construct the circle for each value in citymap.
          // Note: We scale the area of the circle based on the population.
          for (var key in newData) {
            if(newData[key]) {
              
              var datum = data[key];
              var temp = Math.ceil(Number(datum.temp) / 10) * 10;
              // Add the circle for this city to the map.
              var cityCircle = new google.maps.Circle({
                strokeColor: colors[temp],
                strokeOpacity: 0.2,
                strokeWeight: 1,
                fillColor: colors[temp],
                fillOpacity: 0.2,
                map: map,
                center: { lat: datum.lat, lng: datum.lng },
                radius: 10000
              });
            } else {
              console.log('no data')
            }
          }
        }
      });
      socket.on('disconnect', function(){
        console.log('disconnected')
      });

    })
  </script>

  <!--<script src="/scripts/heatmap.js"></script>
  <script src="/scripts/gmaps-heatmap.js"></script>-->
  <script src="scripts/socket.io.min.js"></script>
  
</body>
</html>

